generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "views"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Раздел 1: Сущности ---

model Company {
  id                    Int     @id @default(autoincrement())
  name                  String  @db.VarChar(255)
  inn                   String  @unique @db.VarChar(12)
  kpp                   String? @db.VarChar(9)
  ogrn                  String  @db.VarChar(15)
  description           String? @db.Text
  rating                Decimal @default(0) @db.Decimal(2, 1)

  organizationTypeId    Int  @map("organization_type_id")
  verificationStatusId  Int? @map("verification_status_id")
  responsibleEmployeeId Int? @map("responsible_employee_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Основные связи
  addresses CompanyAddress[]
  users            User[]
  suppliedProducts Product[]
  purchaseRequests PurchaseRequest[] @relation("BuyerRequests")
  openRequests     PurchaseRequest[] @relation("SupplierOpenRequests")
  paymentDetails   PaymentDetail[] 

  // Networking
  sentCooperationRequests     CooperationRequest[] @relation("Initiator")
  receivedCooperationRequests CooperationRequest[] @relation("Recipient")

  // Trade
  commercialOffers CommercialOffer[]
  buyerDeals       Deal[]            @relation("BuyerDeals")
  supplierDeals    Deal[]            @relation("SupplierDeals")

  // Governance & Analytics (Этап 13)
  statistics       CompanyStatistics? // 1-to-1
  filedDisputes    Dispute[]          @relation("Claimant")
  defendedDisputes Dispute[]          @relation("Defendant")
  authoredReviews  CompanyReview[]    @relation("ReviewAuthor")
  receivedReviews  CompanyReview[]    @relation("ReviewRecipient")

  // Справочники
  organizationType   OrganizationType    @relation(fields: [organizationTypeId], references: [id])
  verificationStatus VerificationStatus? @relation(fields: [verificationStatusId], references: [id])

  @@index([inn])
  @@index([name])
  @@map("companies")
}

model User {
  id                    Int       @id @default(autoincrement())
  fullName              String    @map("full_name") @db.VarChar(255)
  email                 String    @unique @db.VarChar(255)
  passwordHash          String    @map("password_hash") @db.VarChar(255)
  phone                 String?   @db.VarChar(20)
  position              String?   @db.VarChar(100)
  isActive              Boolean   @default(true) @map("is_active")
  companyId             Int       @map("company_id")
  roleInCompanyId       Int       @map("role_in_company_id")
  refreshTokenHash      String?   @unique @map("refresh_token_hash")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  
  uploadedDocuments     Document[] 
  statusChanges         StatusHistory[]
  
  // Модерация и Отзывы
  moderatedProducts     Product[]       @relation("ProductModerator")
  notifications         Notification[] 
  authoredProductReviews ProductReview[]

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Product {
  id                Int      @id @default(autoincrement())
  name              String   @db.VarChar(255)
  description       String?  @db.Text
  supplierCompanyId Int      @map("supplier_company_id")
  productCategoryId Int      @map("product_category_id")
  productStatusId   Int      @map("product_status_id")
  
  moderatorId       Int?     @map("moderator_id")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  supplier  Company          @relation(fields: [supplierCompanyId], references: [id], onDelete: Cascade)
  category  ProductCategory  @relation(fields: [productCategoryId], references: [id])
  status    ProductStatus    @relation(fields: [productStatusId], references: [id])
  moderator User?            @relation("ProductModerator", fields: [moderatorId], references: [id]) // Связь с модератором
  
  variants  ProductVariant[]
  images    ProductImage[]

  @@index([name])
  @@map("products")
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  imageUrl  String  @map("image_url") @db.VarChar(255)
  isMain    Boolean @default(false) @map("is_main")
  productId Int     @map("product_id")

  variantId Int?    @map("variant_id")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id                Int     @id @default(autoincrement())
  productId         Int     @map("product_id")
  sku               String? @unique @db.VarChar(100)
  variantName       String? @map("variant_name") @db.VarChar(255)
  price             Decimal @db.Decimal(10, 2)
  minOrderQuantity  Int     @default(1) @map("min_order_quantity")
  stockQuantity     Int?    @map("stock_quantity")
  measurementUnitId Int     @map("measurement_unit_id")
  isActive          Boolean @default(true) @map("is_active")

  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  measurementUnit MeasurementUnit @relation(fields: [measurementUnitId], references: [id])
  
  purchaseRequests PurchaseRequest[]
  offerItems       OfferItem[]
  dealItems       DealItem[]
  images           ProductImage[] 

  @@index([sku])
  @@map("product_variants")
}

model PurchaseRequest {
  id                Int      @id @default(autoincrement())
  comment           String?  @db.Text
  requestStatusId   Int      @map("request_status_id")
  buyerCompanyId    Int      @map("buyer_company_id")
  supplierCompanyId Int?     @map("supplier_company_id")
  productVariantId  Int?     @map("product_variant_id")
  requestedQuantity Int?     @map("requested_quantity")
  createdAt         DateTime @default(now()) @map("created_at")

  buyer    Company           @relation("BuyerRequests", fields: [buyerCompanyId], references: [id], onDelete: Cascade)
  supplier Company?          @relation("SupplierOpenRequests", fields: [supplierCompanyId], references: [id])
  status   RequestStatus     @relation(fields: [requestStatusId], references: [id])

  targetVariant ProductVariant? @relation(fields: [productVariantId], references: [id])

  offers   CommercialOffer[]

  @@map("purchase_requests")
}

model RequestStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) 

  requests PurchaseRequest[]

  @@map("request_statuses")
}

model CommercialOffer {
  id                 Int      @id @default(autoincrement())
  purchaseRequestId  Int      @map("purchase_request_id")
  supplierCompanyId  Int      @map("supplier_company_id")
  offerPrice         Decimal  @map("offer_price") @db.Decimal(12, 2)
  deliveryConditions String?  @map("delivery_conditions") @db.Text
  expiresOn          DateTime @map("expires_on") @db.Date
  offerStatusId      Int      @map("offer_status_id")
  createdAt          DateTime @default(now()) @map("created_at")

  purchaseRequest PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  supplier        Company         @relation(fields: [supplierCompanyId], references: [id], onDelete: Cascade)
  status          OfferStatus     @relation(fields: [offerStatusId], references: [id])

  deal Deal? 
  items OfferItem[]

  @@map("commercial_offers")
}

model OfferItem {
  id               Int     @id @default(autoincrement())
  commercialOfferId Int    @map("commercial_offer_id")
  productVariantId  Int    @map("product_variant_id")
  quantity          Int
  pricePerUnit      Decimal @map("price_per_unit") @db.Decimal(10, 2)

  offer          CommercialOffer @relation(fields: [commercialOfferId], references: [id], onDelete: Cascade)
  productVariant ProductVariant  @relation(fields: [productVariantId], references: [id])

  @@map("offer_items")
}

model OfferStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) 

  offers CommercialOffer[]

  @@map("offer_statuses")
}

// --- Раздел: Справочники (Lookup Tables) ---

model OrganizationType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) 

  companies Company[]

  @@map("organization_types")
}

model VerificationStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) 

  companies Company[]

  @@map("verification_statuses")
}

model ProductCategory {
  id       Int     @id @default(autoincrement())
  name     String  @unique @db.VarChar(100)
  parentId Int?    @map("parent_id")

  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

model MeasurementUnit {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(20)

  productVariants ProductVariant[]

  @@map("measurement_units")
}

model ProductStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  products Product[]

  @@map("product_statuses")
}

model PaymentDetail {
  id                   Int     @id @default(autoincrement())
  bankName             String  @map("bank_name") @db.VarChar(255)
  bik                  String  @db.VarChar(9)
  checkingAccount      String  @map("checking_account") @db.VarChar(20)
  correspondentAccount String  @map("correspondent_account") @db.VarChar(20)
  isPrimary            Boolean @default(false) @map("is_primary")
  companyId            Int     @map("company_id")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("payment_details")
}

model Address {
  id            Int     @id @default(autoincrement())
  postalCode    String? @map("postal_code") @db.VarChar(20)
  country       String  @db.VarChar(100)
  region        String? @db.VarChar(150)
  city          String? @db.VarChar(150)
  street        String? @db.VarChar(255)
  house         String? @db.VarChar(50)
  building      String? @db.VarChar(50)
  apartment     String? @db.VarChar(50)
  comment       String? @db.Text
  
  // Технические поля
  createdAt     DateTime @default(now()) @map("created_at")

  // Обратные связи
  companies     CompanyAddress[]
  deals         Deal[] // Сделки, где этот адрес использован для доставки

  @@map("addresses")
}

model AddressType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // 'Юридический', 'Фактический', 'Склад', 'Почтовый'

  companyAddresses CompanyAddress[]

  @@map("address_types")
}

// Промежуточная таблица для связи Компаний и Адресов
model CompanyAddress {
  companyId     Int @map("company_id")
  addressId     Int @map("address_id")
  addressTypeId Int @map("address_type_id")

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  address     Address     @relation(fields: [addressId], references: [id], onDelete: Cascade)
  addressType AddressType @relation(fields: [addressTypeId], references: [id])

  @@id([companyId, addressId, addressTypeId])
  @@map("company_addresses")
}

// --- Раздел 4: Документы ---

model Document {
  id               Int      @id @default(autoincrement())
  entityType       String   @map("entity_type") @db.VarChar(50) 
  entityId         Int      @map("entity_id")
  fileUrl          String   @map("file_url") @db.VarChar(255) 
  documentTypeId   Int      @map("document_type_id")
  documentStatusId Int      @map("document_status_id") @default(1)

  uploadedById Int      @map("uploaded_by_id") 
  createdAt    DateTime @default(now()) @map("created_at")

  documentType   DocumentType   @relation(fields: [documentTypeId], references: [id])
  documentStatus DocumentStatus @relation(fields: [documentStatusId], references: [id])
  uploader       User           @relation(fields: [uploadedById], references: [id])

  @@index([entityType, entityId])
  @@map("documents")
}

model DocumentType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(100) 

  documents Document[]

  @@map("document_types")
}

model DocumentStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  documents Document[]

  @@map("document_statuses")
}

// --- Раздел: Networking ---

model CooperationRequest {
  id                   Int    @id @default(autoincrement())
  message              String @db.Text
  initiator_company_id Int
  recipient_company_id Int
  request_status_id    Int

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  initiatorCompany Company                  @relation("Initiator", fields: [initiator_company_id], references: [id], onDelete: Cascade)
  recipientCompany Company                  @relation("Recipient", fields: [recipient_company_id], references: [id], onDelete: Cascade)
  status           CooperationRequestStatus @relation(fields: [request_status_id], references: [id])

  @@map("cooperation_requests")
}

model CooperationRequestStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  requests CooperationRequest[]

  @@map("cooperation_request_statuses")
}

model DealStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  deals Deal[]

  @@map("deal_statuses")
}

model EscrowAccountStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  escrowAccounts EscrowAccount[]

  @@map("escrow_account_statuses")
}

model TransactionType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  transactions Transaction[]

  @@map("transaction_types")
}

model TransactionStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  transactions Transaction[]

  @@map("transaction_statuses")
}

model Deal {
  id                Int  @id @default(autoincrement())
  buyerCompanyId    Int  @map("buyer_company_id")
  supplierCompanyId Int  @map("supplier_company_id")
  commercialOfferId Int? @unique @map("commercial_offer_id") 

  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  dealStatusId  Int     @map("deal_status_id")
  deliveryTerms String? @map("delivery_terms") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  deliveryAddressId Int? @map("delivery_address_id")

  buyer           Company          @relation("BuyerDeals", fields: [buyerCompanyId], references: [id])
  supplier        Company          @relation("SupplierDeals", fields: [supplierCompanyId], references: [id])
  commercialOffer CommercialOffer? @relation(fields: [commercialOfferId], references: [id])
  status          DealStatus       @relation(fields: [dealStatusId], references: [id])
  deliveryAddress Address? @relation(fields: [deliveryAddressId], references: [id])


  escrowAccount   EscrowAccount?
  transactions    Transaction[]
  items           DealItem[] 
  shipments       Shipment[] 
  
  // Governance
  disputes        Dispute[]
  companyReviews  CompanyReview[]

  @@map("deals")
}

model DealItem {
  id               Int      @id @default(autoincrement())
  dealId           Int      @map("deal_id")
  productVariantId Int      @map("product_variant_id")
  quantity         Int
  pricePerUnit     Decimal? @map("price_per_unit") @db.Decimal(10, 2) 

  productNameAtDealMoment     String? @map("product_name_at_deal_moment") @db.VarChar(255)
  variantNameAtDealMoment     String? @map("variant_name_at_deal_moment") @db.VarChar(255)
  measurementUnitAtDealMoment String? @map("measurement_unit_at_deal_moment") @db.VarChar(20)

  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id])
  
  productReview  ProductReview? // Обратная связь 1-к-1 или 1-к-N (здесь 1-к-1 логичнее)

  @@map("deal_items")
}

// --- Раздел 5: Финансы (Этап 8) ---

model EscrowAccount {
  dealId            Int     @id @map("deal_id")
  totalAmount       Decimal @map("total_amount") @db.Decimal(12, 2)
  amountDeposited   Decimal @default(0) @map("amount_deposited") @db.Decimal(12, 2)
  platformFeeAmount Decimal @map("platform_fee_amount") @db.Decimal(12, 2)
  escrowStatusId    Int     @default(1) @map("escrow_status_id") 
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  deal   Deal                @relation(fields: [dealId], references: [id])
  status EscrowAccountStatus @relation(fields: [escrowStatusId], references: [id])

  @@map("escrow_accounts")
}

model Transaction {
  id                  Int       @id @default(autoincrement())
  amount              Decimal   @db.Decimal(12, 2)
  externalPaymentId   String?   @map("external_payment_id") @db.VarChar(255)
  dealId              Int       @map("deal_id")
  transactionTypeId   Int       @map("transaction_type_id") 
  transactionStatusId Int       @map("transaction_status_id") 
  createdAt           DateTime  @default(now()) @map("created_at")
  processedAt         DateTime? @map("processed_at")

  deal   Deal              @relation(fields: [dealId], references: [id])
  type   TransactionType   @relation(fields: [transactionTypeId], references: [id])
  status TransactionStatus @relation(fields: [transactionStatusId], references: [id])

  @@map("transactions")
}

// --- Раздел 6: Логистика (Этап 10) ---

model Shipment {
  id               Int       @id @default(autoincrement())
  trackingNumber   String    @unique @map("tracking_number") @db.VarChar(100)
  logisticsService String?   @map("logistics_service") @db.VarChar(100) 
  sentAt           DateTime? @map("sent_at")
  expectedDeliveryDate DateTime? @map("expected_delivery_date") @db.Date
  
  dealId           Int       @map("deal_id")
  deliveryStatusId Int       @map("delivery_status_id")

  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  deliveryStatus DeliveryStatus @relation(fields: [deliveryStatusId], references: [id])

  @@map("shipments")
}

model DeliveryStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  shipments Shipment[]

  @@map("delivery_statuses")
}

// --- Раздел 7: Логирование и История ---

model StatusHistory {
  id              Int      @id @default(autoincrement())
  entityType      String   @map("entity_type") @db.VarChar(50) 
  entityId        Int      @map("entity_id")
  
  oldStatusId     Int?     @map("old_status_id")
  newStatusId     Int      @map("new_status_id")
  
  initiatorUserId Int?     @map("initiator_user_id")
  changedAt       DateTime @default(now()) @map("changed_at")

  initiator       User?    @relation(fields: [initiatorUserId], references: [id])

  @@index([entityType, entityId])
  @@map("status_history")
}

// --- Раздел 13: Governance & Analytics ---

model Dispute {
  id                 Int       @id @default(autoincrement())
  dealId             Int       @map("deal_id")
  disputeReason      String    @map("dispute_reason") @db.Text
  claimantDemands    String    @map("claimant_demands") @db.Text
  finalDecision      String?   @map("final_decision") @db.Text
  refundAmount       Decimal?  @map("refund_amount") @db.Decimal(12, 2)
  
  claimantCompanyId  Int       @map("claimant_company_id")
  defendantCompanyId Int       @map("defendant_company_id")
  arbiterId          Int?      @map("arbiter_id")
  disputeStatusId    Int       @map("dispute_status_id")
  
  openedAt           DateTime  @default(now()) @map("opened_at")
  closedAt           DateTime? @map("closed_at")

  deal      Deal          @relation(fields: [dealId], references: [id])
  status    DisputeStatus @relation(fields: [disputeStatusId], references: [id])
  
  claimant  Company       @relation("Claimant", fields: [claimantCompanyId], references: [id])
  defendant Company       @relation("Defendant", fields: [defendantCompanyId], references: [id])

  @@map("disputes")
}

model DisputeStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) 

  disputes Dispute[]

  @@map("dispute_statuses")
}

model CompanyReview {
  id                 Int      @id @default(autoincrement())
  serviceRating      Int      @map("service_rating") // 1-5
  serviceComment     String?  @map("service_comment") @db.Text
  reviewResponse     String?  @map("review_response") @db.Text
  
  dealId             Int      @map("deal_id")
  reviewStatusId     Int      @map("review_status_id")
  
  authorCompanyId    Int      @map("author_company_id")
  recipientCompanyId Int      @map("recipient_company_id")
  moderatorId        Int?     @map("moderator_id")
  
  createdAt          DateTime @default(now()) @map("created_at")

  deal      Deal         @relation(fields: [dealId], references: [id])
  status    ReviewStatus @relation(fields: [reviewStatusId], references: [id])
  
  author    Company      @relation("ReviewAuthor", fields: [authorCompanyId], references: [id])
  recipient Company      @relation("ReviewRecipient", fields: [recipientCompanyId], references: [id])

  @@map("company_reviews")
}

model ReviewStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) 

  reviews        CompanyReview[]
  productReviews ProductReview[]

  @@map("review_statuses")
}

model CompanyStatistics {
  companyId            Int      @id @map("company_id")
  totalDealsAsSupplier Int      @default(0) @map("total_deals_as_supplier")
  totalSalesVolume     Decimal  @default(0) @map("total_sales_volume") @db.Decimal(15, 2)
  averageSalesCheck    Decimal  @default(0) @map("average_sales_check") @db.Decimal(12, 2)
  
  totalDealsAsBuyer    Int      @default(0) @map("total_deals_as_buyer")
  totalPurchasesVolume Decimal  @default(0) @map("total_purchases_volume") @db.Decimal(15, 2)
  
  lastUpdatedAt        DateTime @default(now()) @map("last_updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_statistics")
}

model ProductReview {
  id             Int      @id @default(autoincrement())
  productRating  Int      @map("product_rating")
  productComment String   @map("product_comment") @db.Text
  dealItemId     Int      @unique @map("deal_item_id")
  reviewStatusId Int      @map("review_status_id")
  authorUserId   Int      @map("author_user_id")
  moderatorId    Int?     @map("moderator_id")
  createdAt      DateTime @default(now()) @map("created_at")

  dealItem DealItem     @relation(fields: [dealItemId], references: [id])
  status   ReviewStatus @relation(fields: [reviewStatusId], references: [id])
  author   User         @relation(fields: [authorUserId], references: [id])

  @@map("product_reviews")
}

model Notification {
  id                 Int      @id @default(autoincrement())
  recipientId        Int      @map("recipient_id")
  title              String   @db.VarChar(255)
  message            String   @db.Text
  type               String   @default("INFO") @db.VarChar(50) // INFO, WARNING, SUCCESS, ERROR
  
  entityType         String?  @map("entity_type") @db.VarChar(50) // deal, dispute, ticket
  entityId           Int?     @map("entity_id")
  
  isRead             Boolean  @default(false) @map("is_read")
  createdAt          DateTime @default(now()) @map("created_at")

  recipient          User     @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([isRead])
  @@map("notifications")
}