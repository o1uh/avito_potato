generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "views"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Раздел 1: Сущности ---

model Company {
  id                    Int     @id @default(autoincrement())
  name                  String  @db.VarChar(255)
  inn                   String  @unique @db.VarChar(12)
  kpp                   String? @db.VarChar(9)
  ogrn                  String  @db.VarChar(15)
  description           String? @db.Text
  rating                Decimal @default(0) @db.Decimal(2, 1)

  organizationTypeId    Int  @map("organization_type_id")
  verificationStatusId  Int? @map("verification_status_id")
  responsibleEmployeeId Int? @map("responsible_employee_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  users            User[]
  suppliedProducts Product[]
  purchaseRequests PurchaseRequest[] @relation("BuyerRequests")
  openRequests     PurchaseRequest[] @relation("SupplierOpenRequests")
  paymentDetails   PaymentDetail[] // Обратная связь для банковских счетов

  sentCooperationRequests     CooperationRequest[] @relation("Initiator")
  receivedCooperationRequests CooperationRequest[] @relation("Recipient")

  commercialOffers CommercialOffer[]
  buyerDeals       Deal[]            @relation("BuyerDeals")
  supplierDeals    Deal[]            @relation("SupplierDeals")

  // Связи со справочниками
  organizationType   OrganizationType    @relation(fields: [organizationTypeId], references: [id])
  verificationStatus VerificationStatus? @relation(fields: [verificationStatusId], references: [id])

  @@index([inn])
  @@index([name])
  @@map("companies")
}

model User {
  id                    Int       @id @default(autoincrement())
  fullName              String    @map("full_name") @db.VarChar(255)
  email                 String    @unique @db.VarChar(255)
  passwordHash          String    @map("password_hash") @db.VarChar(255)
  phone                 String?   @db.VarChar(20)
  position              String?   @db.VarChar(100)
  isActive              Boolean   @default(true) @map("is_active")
  companyId             Int       @map("company_id")
  roleInCompanyId       Int       @map("role_in_company_id")
  refreshTokenHash      String?   @unique @map("refresh_token_hash")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  uploadedDocuments     Document[] // Связь с документами
  statusChanges         StatusHistory[]

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Product {
  id                Int      @id @default(autoincrement())
  name              String   @db.VarChar(255)
  description       String?  @db.Text
  supplierCompanyId Int      @map("supplier_company_id")
  productCategoryId Int      @map("product_category_id")
  productStatusId   Int      @map("product_status_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  supplier Company          @relation(fields: [supplierCompanyId], references: [id], onDelete: Cascade)
  category ProductCategory  @relation(fields: [productCategoryId], references: [id])
  status   ProductStatus    @relation(fields: [productStatusId], references: [id])
  variants ProductVariant[]
  images   ProductImage[]

  @@index([name])
  @@map("products")
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  imageUrl  String  @map("image_url") @db.VarChar(255)
  isMain    Boolean @default(false) @map("is_main")
  productId Int     @map("product_id")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id                Int     @id @default(autoincrement())
  productId         Int     @map("product_id")
  sku               String? @unique @db.VarChar(100)
  variantName       String? @map("variant_name") @db.VarChar(255)
  price             Decimal @db.Decimal(10, 2)
  minOrderQuantity  Int     @default(1) @map("min_order_quantity")
  stockQuantity     Int?    @map("stock_quantity")
  measurementUnitId Int     @map("measurement_unit_id")
  isActive          Boolean @default(true) @map("is_active")

  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  measurementUnit MeasurementUnit @relation(fields: [measurementUnitId], references: [id])
  
  // ДОБАВЛЕНО: Обратная связь для DealItem
  dealItems       DealItem[]

  @@index([sku])
  @@map("product_variants")
}

model PurchaseRequest {
  id                Int      @id @default(autoincrement())
  comment           String?  @db.Text
  requestStatusId   Int      @map("request_status_id")
  buyerCompanyId    Int      @map("buyer_company_id")
  supplierCompanyId Int?     @map("supplier_company_id")
  createdAt         DateTime @default(now()) @map("created_at")

  // Связи
  buyer  Company           @relation("BuyerRequests", fields: [buyerCompanyId], references: [id], onDelete: Cascade)
  supplier Company?        @relation("SupplierOpenRequests", fields: [supplierCompanyId], references: [id])
  status RequestStatus     @relation(fields: [requestStatusId], references: [id])
  offers CommercialOffer[]

  @@map("purchase_requests")
}

model RequestStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "New", "Closed"

  requests PurchaseRequest[]

  @@map("request_statuses")
}

model CommercialOffer {
  id                 Int      @id @default(autoincrement())
  purchaseRequestId  Int      @map("purchase_request_id")
  supplierCompanyId  Int      @map("supplier_company_id")
  offerPrice         Decimal  @map("offer_price") @db.Decimal(12, 2)
  deliveryConditions String?  @map("delivery_conditions") @db.Text
  expiresOn          DateTime @map("expires_on") @db.Date
  offerStatusId      Int      @map("offer_status_id")
  createdAt          DateTime @default(now()) @map("created_at")

  purchaseRequest PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  supplier        Company         @relation(fields: [supplierCompanyId], references: [id], onDelete: Cascade)
  status          OfferStatus     @relation(fields: [offerStatusId], references: [id])

  deal Deal? // Связь со сделкой (если принят)

  @@map("commercial_offers")
}

model OfferStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "Sent", "Accepted", "Rejected"

  offers CommercialOffer[]

  @@map("offer_statuses")
}

// --- Раздел: Справочники (Lookup Tables) ---

model OrganizationType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "ООО", "ИП"

  companies Company[]

  @@map("organization_types")
}

model VerificationStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "Не верифицирован", "Верифицирован"

  companies Company[]

  @@map("verification_statuses")
}

model ProductCategory {
  id       Int     @id @default(autoincrement())
  name     String  @unique @db.VarChar(100)
  parentId Int?    @map("parent_id")

  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

model MeasurementUnit {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(20) // "кг", "шт", "литр"

  productVariants ProductVariant[]

  @@map("measurement_units")
}

model ProductStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "Черновик", "Опубликован"

  products Product[]

  @@map("product_statuses")
}

model PaymentDetail {
  id                   Int     @id @default(autoincrement())
  bankName             String  @map("bank_name") @db.VarChar(255)
  bik                  String  @db.VarChar(9)
  checkingAccount      String  @map("checking_account") @db.VarChar(20)
  correspondentAccount String  @map("correspondent_account") @db.VarChar(20)
  isPrimary            Boolean @default(false) @map("is_primary")
  companyId            Int     @map("company_id")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("payment_details")
}

// --- Раздел 4: Документы ---

model Document {
  id               Int      @id @default(autoincrement())
  entityType       String   @map("entity_type") @db.VarChar(50) // 'deal', 'company', 'product'
  entityId         Int      @map("entity_id")
  fileUrl          String   @map("file_url") @db.VarChar(255) // Ссылка на S3
  documentTypeId   Int      @map("document_type_id")
  documentStatusId Int      @map("document_status_id") @default(1)

  uploadedById Int      @map("uploaded_by_id") // Кто загрузил или инициировал генерацию
  createdAt    DateTime @default(now()) @map("created_at")

  documentType   DocumentType   @relation(fields: [documentTypeId], references: [id])
  documentStatus DocumentStatus @relation(fields: [documentStatusId], references: [id])
  uploader       User           @relation(fields: [uploadedById], references: [id])

  @@index([entityType, entityId])
  @@map("documents")
}

// --- Справочники для документов ---

model DocumentType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(100) // "Договор", "Счет", "УПД"

  documents Document[]

  @@map("document_types")
}

model DocumentStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "Создан", "Подписан", "Архив"

  documents Document[]

  @@map("document_statuses")
}

// --- Раздел: Networking (Новое) ---

model CooperationRequest {
  id                   Int    @id @default(autoincrement())
  message              String @db.Text
  initiator_company_id Int
  recipient_company_id Int
  request_status_id    Int

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  initiatorCompany Company                  @relation("Initiator", fields: [initiator_company_id], references: [id], onDelete: Cascade)
  recipientCompany Company                  @relation("Recipient", fields: [recipient_company_id], references: [id], onDelete: Cascade)
  status           CooperationRequestStatus @relation(fields: [request_status_id], references: [id])

  @@map("cooperation_requests")
}

model CooperationRequestStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "Pending", "Approved", "Rejected"

  requests CooperationRequest[]

  @@map("cooperation_request_statuses")
}

model DealStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  deals Deal[]

  @@map("deal_statuses")
}

model EscrowAccountStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  // Связь с EscrowAccount (нужно будет обновить модель EscrowAccount ниже)
  escrowAccounts EscrowAccount[]

  @@map("escrow_account_statuses")
}

model TransactionType {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  transactions Transaction[]

  @@map("transaction_types")
}

model TransactionStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  transactions Transaction[]

  @@map("transaction_statuses")
}

model Deal {
  id                Int  @id @default(autoincrement())
  buyerCompanyId    Int  @map("buyer_company_id")
  supplierCompanyId Int  @map("supplier_company_id")
  commercialOfferId Int? @unique @map("commercial_offer_id") // Ссылка на КП

  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  dealStatusId  Int     @map("deal_status_id")
  deliveryTerms String? @map("delivery_terms") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Связи
  buyer           Company          @relation("BuyerDeals", fields: [buyerCompanyId], references: [id])
  supplier        Company          @relation("SupplierDeals", fields: [supplierCompanyId], references: [id])
  commercialOffer CommercialOffer? @relation(fields: [commercialOfferId], references: [id])
  status            DealStatus @relation(fields: [dealStatusId], references: [id])

  
  escrowAccount EscrowAccount?
  transactions  Transaction[]
  items         DealItem[] // Товары в сделке
  shipments     Shipment[] 


  @@map("deals")
}

model DealItem {
  id               Int      @id @default(autoincrement())
  dealId           Int      @map("deal_id")
  productVariantId Int      @map("product_variant_id")
  quantity         Int
  pricePerUnit     Decimal? @map("price_per_unit") @db.Decimal(10, 2) // Заполняется триггером

  // Снапшоты данных на момент сделки (заполняются триггером)
  productNameAtDealMoment     String? @map("product_name_at_deal_moment") @db.VarChar(255)
  variantNameAtDealMoment     String? @map("variant_name_at_deal_moment") @db.VarChar(255)
  measurementUnitAtDealMoment String? @map("measurement_unit_at_deal_moment") @db.VarChar(20)

  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id])

  @@map("deal_items")
}

// --- Раздел 5: Финансы (Этап 8) ---

model EscrowAccount {
  dealId            Int     @id @map("deal_id")
  totalAmount       Decimal @map("total_amount") @db.Decimal(12, 2)
  amountDeposited   Decimal @default(0) @map("amount_deposited") @db.Decimal(12, 2)
  platformFeeAmount Decimal @map("platform_fee_amount") @db.Decimal(12, 2)
  escrowStatusId    Int     @default(1) @map("escrow_status_id") // 1=Waiting, 2=Funded, 3=Released, 4=Refunded
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")


  deal Deal @relation(fields: [dealId], references: [id])
  status            EscrowAccountStatus @relation(fields: [escrowStatusId], references: [id])


  @@map("escrow_accounts")
}

model Transaction {
  id                  Int       @id @default(autoincrement())
  amount              Decimal   @db.Decimal(12, 2)
  externalPaymentId   String?   @map("external_payment_id") @db.VarChar(255)
  dealId              Int       @map("deal_id")
  transactionTypeId   Int       @map("transaction_type_id") // 1=Deposit, 2=Release, 3=Refund
  transactionStatusId Int       @map("transaction_status_id") // 1=Pending, 2=Success, 3=Fail
  createdAt           DateTime  @default(now()) @map("created_at")
  processedAt         DateTime? @map("processed_at")

  deal Deal @relation(fields: [dealId], references: [id])
  type                TransactionType @relation(fields: [transactionTypeId], references: [id])
  status              TransactionStatus @relation(fields: [transactionStatusId], references: [id])

  @@map("transactions")
}

// --- Раздел 6: Логистика (Этап 10) ---

model Shipment {
  id               Int       @id @default(autoincrement())
  trackingNumber   String    @unique @map("tracking_number") @db.VarChar(100)
  logisticsService String?   @map("logistics_service") @db.VarChar(100) // "CDEK", "Dellin"
  sentAt           DateTime? @map("sent_at")
  expectedDeliveryDate DateTime? @map("expected_delivery_date") @db.Date
  
  dealId           Int       @map("deal_id")
  deliveryStatusId Int       @map("delivery_status_id")

  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  deliveryStatus DeliveryStatus @relation(fields: [deliveryStatusId], references: [id])

  @@map("shipments")
}

model DeliveryStatus {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50) // "In Transit", "Delivered", "Problem"

  shipments Shipment[]

  @@map("delivery_statuses")
}

// --- Раздел 7: Логирование и История ---

model StatusHistory {
  id              Int      @id @default(autoincrement())
  entityType      String   @map("entity_type") @db.VarChar(50) // 'DEAL', 'PRODUCT'
  entityId        Int      @map("entity_id")
  
  oldStatusId     Int?     @map("old_status_id")
  newStatusId     Int      @map("new_status_id")
  
  initiatorUserId Int?     @map("initiator_user_id")
  changedAt       DateTime @default(now()) @map("changed_at")

  // Опциональная связь, если захотим делать .include()
  initiator       User?    @relation(fields: [initiatorUserId], references: [id])

  @@index([entityType, entityId])
  @@map("status_history")
}