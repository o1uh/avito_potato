generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "views"] 
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Раздел 1: Сущности ---

model Company {
  id                      Int      @id @default(autoincrement())
  name                    String   @db.VarChar(255)
  inn                     String   @unique @db.VarChar(12)
  kpp                     String?  @db.VarChar(9)
  ogrn                    String   @db.VarChar(15)
  description             String?  @db.Text
  rating                  Decimal  @default(0) @db.Decimal(2, 1)
  
  organizationTypeId      Int      @map("organization_type_id")
  verificationStatusId    Int?     @map("verification_status_id")
  responsibleEmployeeId   Int?     @map("responsible_employee_id")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at")

  users                   User[]
  suppliedProducts        Product[]
  purchaseRequests        PurchaseRequest[] @relation("BuyerRequests")
  openRequests            PurchaseRequest[] @relation("SupplierOpenRequests")
  
  // Связи со справочниками
  organizationType        OrganizationType @relation(fields: [organizationTypeId], references: [id])
  verificationStatus      VerificationStatus? @relation(fields: [verificationStatusId], references: [id])

  @@map("companies")
  @@index([inn])
  @@index([name])
}

model User {
  id                   Int      @id @default(autoincrement())
  fullName             String   @map("full_name") @db.VarChar(255)
  email                String   @unique @db.VarChar(255)
  passwordHash         String   @map("password_hash") @db.VarChar(255)
  phone                String?  @db.VarChar(20)
  position             String?  @db.VarChar(100)
  isActive             Boolean  @default(true) @map("is_active")
  companyId            Int      @map("company_id")
  roleInCompanyId      Int      @map("role_in_company_id")
  refreshTokenHash     String?  @unique @map("refresh_token_hash")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  createdAt            DateTime @default(now()) @map("created_at")

  company              Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Product {
  id                Int      @id @default(autoincrement())
  name              String   @db.VarChar(255)
  description       String?  @db.Text
  supplierCompanyId Int      @map("supplier_company_id")
  productCategoryId Int      @map("product_category_id")
  productStatusId   Int      @map("product_status_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  supplier          Company         @relation(fields: [supplierCompanyId], references: [id], onDelete: Cascade)
  category          ProductCategory @relation(fields: [productCategoryId], references: [id])
  status            ProductStatus   @relation(fields: [productStatusId], references: [id])
  variants          ProductVariant[]

  @@map("products")
  @@index([name])
}

model ProductVariant {
  id                 Int      @id @default(autoincrement())
  productId          Int      @map("product_id")
  sku                String?  @unique @db.VarChar(100)
  variantName        String?  @map("variant_name") @db.VarChar(255)
  price              Decimal  @db.Decimal(10, 2)
  minOrderQuantity   Int      @default(1) @map("min_order_quantity")
  stockQuantity      Int?     @map("stock_quantity")
  measurementUnitId  Int      @map("measurement_unit_id")
  isActive           Boolean  @default(true) @map("is_active")

  product            Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  measurementUnit    MeasurementUnit @relation(fields: [measurementUnitId], references: [id])

  @@map("product_variants")
  @@index([sku])
}

model PurchaseRequest {
  id                Int      @id @default(autoincrement())
  comment           String?  @db.Text
  requestStatusId   Int      @map("request_status_id")
  buyerCompanyId    Int      @map("buyer_company_id")
  supplierCompanyId Int?     @map("supplier_company_id")
  createdAt         DateTime @default(now()) @map("created_at")

  buyer             Company  @relation("BuyerRequests", fields: [buyerCompanyId], references: [id], onDelete: Cascade)
  supplier          Company? @relation("SupplierOpenRequests", fields: [supplierCompanyId], references: [id])

  @@map("purchase_requests")
}

// --- Раздел: Справочники (Lookup Tables) ---

model OrganizationType {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50) // "ООО", "ИП"
  
  companies Company[]

  @@map("organization_types")
}

model VerificationStatus {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50) // "Не верифицирован", "Верифицирован"

  companies Company[]

  @@map("verification_statuses")
}

model ProductCategory {
  id       Int    @id @default(autoincrement())
  name     String @unique @db.VarChar(100)
  parentId Int?   @map("parent_id")
  
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

model MeasurementUnit {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(20) // "кг", "шт", "литр"

  productVariants ProductVariant[]

  @@map("measurement_units")
}

model ProductStatus {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50) // "Черновик", "Опубликован"

  products Product[]

  @@map("product_statuses")
}