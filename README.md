Текущий статус проекта: **v1.2.0  — Добавлен Frontend (Авторизация, Профиль, Сотрудники, Нетворкинг)**.

### Готовые клиентские модули:
- `App & Shared`: Инфраструктура (Vite, Axios, Zustand, React Query), UI Kit (Ant Design + Tailwind).
- `Auth`: Формы входа и регистрации с валидацией ИНН (DaData) и UX-индикацией.
- `Profile`: Личный кабинет, управление реквизитами, адресами и банковскими счетами.
- `Team`: Управление сотрудниками (приглашение, роли, удаление).
- `Networking`: Интерфейс управления деловыми связями (партнеры, входящие/исходящие запросы).

### Готовые серверные модули:
- `Auth`: JWT, регистрация, ролевая модель (RBAC).
- `References`: Справочники с кэшированием в Redis.
- `Users` & `Companies`: Профили, проверка контрагентов (DaData), управление сотрудниками (Team Management).
- `Catalog`: Управление товарами, синхронизация с Elasticsearch, фасетный поиск.
- `Documents`: Генерация PDF (Счета, Договоры, Акты), загрузка в S3/MinIO.
- `Finance`: Эскроу-счета, транзакции, хранимые процедуры БД для атомарности, расчет комиссий и интеграция с Банком (Вебхуки/Точка).
- `Trade`: Полный цикл сделки (RFQ -> КП -> Сделка), стейт-машина статусов, логистика (интеграция СДЭК).
- `Governance`: Система Арбитража (споры по сделкам), Отзывы и Рейтинги компаний (DB Triggers).
- `Analytics`: Сбор статистики (Cron), Дашборды для пользователей и админа, Экспорт отчетов (CSV).
- `Admin`: Панель модерации товаров, блокировка пользователей/компаний.
- `Communication`: Система внутренних уведомлений (хранение в БД + Email), REST API для списка уведомлений и статуса прочтения.

---

## 1. ПРАВИЛА РАБОТЫ С GIT

### Структура веток
*   **main** — `Stable/Prod`. Содержит версию, развернутую на боевом сервере.
    *   ⛔️ **Прямые коммиты запрещены.**
    *   ✅ Изменения попадают только через Merge из веток `rel/...`.
*   **dev** — `Development`. Основная ветка разработки.
    *   Сюда стекаются все готовые задачи.
    *   От этой ветки создаются ветки задач (`feat/...`).
*   **feat/название-задачи** — Разработка нового функционала.
    *   Ответвляется от: `dev`.
    *   Вливается в: `dev`.
*   **rel/vX.X.X** — Стабилизация перед релизом.
    *   Ответвляется от: `dev`.
    *   Вливается в: `main` и `dev`.
*   **dbg/название-бага** — Исправление критических ошибок (hotfix).

### Формат коммитов
Шаблон: `тип(модуль): описание действия`

**1. Типы (Types):**
*   `feat`: Новая функциональность.
*   `fix`: Исправление ошибки.
*   `cfg`: Конфигурация, обновление библиотек, .gitignore.
*   `ref`: Рефакторинг (без изменения логики).
*   `test`: Написание тестов.
*   `wip`: Черновик (Work In Progress). **Обязательно удалить/объединить (Squash) перед слиянием!**

**2. Модули (Scopes):**
*    **Общие:** `root` (корневые конфиги), `docs` (документация), `infra` (DevOps/Docker).
*   **Backend:** `b/auth`, `b/users`, `b/catalog`, `b/trade`, `b/finance`, `b/docs` (генерация), `b/chat`, `b/admin`, `b/common`.
*   **Frontend:** `f/auth`, `f/catalog`, `f/trade`, `f/profile`, `f/ui` (UI Kit), `f/core` (настройки App), `f/shared` (утилиты/api).

**3. Примеры:**
*   ✅ `feat(f/auth): реализация аутентификации`
*   ✅ `fix(bf/catalog): исправление фильтрации по цене`
*   ✅ `cfg(b/infra): обновление зависимостей nestjs`
*   ❌ `исправил баги` (нет типа и модуля)
*   ❌ `wip` (нельзя оставлять в истории ветки)

### Алгоритм работы в Sublime Merge
1.  **Checkout dev** → **Pull**. Получить актуальное состояние проекта.
2.  **Create Branch** от `dev`. Назвать по формату: `feat/setup-auth`.
3.  **Work**. Внесение изменений в код.
4.  **Commit**. Фиксация изменений с правильным сообщением.
5.  **Squash** (Опционально). Если в процессе было много мелких коммитов или `wip`, объедините их в один смысловой коммит перед слиянием.
6.  **Merge** в `dev`:
    *   Переключиться на `dev`.
    *   Нажать ПКМ на вашу ветку → **Merge...**
    *   **ВАЖНО:** Выбрать опцию `--no-ff` (No Fast Forward), чтобы сохранить историю ветвления.
7.  **Push**. Отправка изменений на сервер.

---

## 2. ЗАПУСК ПРОЕКТА (Разработка)

Выполняйте шаги последовательно, чтобы развернуть проект с нуля.

### Предварительные требования
*   **Node.js** (v16+)
*   **Docker Desktop** (включенный и запущенный)

### Шаг 1: Клонирование и зависимости
```bash
git clone <ссылка_на_репозиторий>
cd prodopt-backend
npm install
```

### Шаг 2: Настройка окружения
1.  Создайте файл `.env` в корне проекта.
2.  Запросите актуальное содержимое `.env` и вставьте его в файл.

### Шаг 3: Поднятие инфраструктуры (Docker)
Эта команда скачивает образы и запускает контейнеры: PostgreSQL, Redis, MinIO, Elastic.
```bash
docker compose up -d
```
*Ждем 10-15 секунд, пока базы данных инициализируются.*

### Шаг 4: Настройка Базы Данных (/)
Применяем схему к базе данных и **обязательно** заполняем её начальными данными (Справочники, Админ).
```bash
# Применение миграций
npx prisma migrate dev

# Наполнение справочниками (Seed)
npm run prisma:seed
```

### Шаг 5: Запуск сервера
Запуск бэкенда в режиме разработки (с горячей перезагрузкой).
```bash
npm run start:dev
```
*   API доступно по адресу: `http://localhost:3000`
*   Swagger документация (если подключена): `http://localhost:3000/api`
*   Проверка состояния: `http://localhost:3000/health`

### Шаг 6: Запуск Фронтенда
Откройте **новый терминал**, перейдите в папку фронтенда и запустите его.
```bash
cd prodopt-frontend
npm install
npm run dev
```
*   Приложение доступно по адресу: `http://localhost:5173`


### Шаг 6: Инструменты разработчика (Swagger и Prisma Studio)
**1. Swagger UI (Документация API):**
Для ручного тестирования эндпоинтов и просмотра схем данных откройте в браузере:
*   URL: `http://localhost:3000/api`

**2. Prisma Studio (Просмотр БД):**
Для визуального управления данными в базе (просмотр таблиц Users, Companies и др.) откройте новый терминал и выполните:
```bash
npx prisma studio
```
Интерфейс откроется в браузере по адресу `http://localhost:5555`.

**3. MinIO Console (S3 Хранилище):**
Для просмотра и управления загруженными файлами (PDF документы, изображения товаров) откройте в браузере:
*   URL: `http://localhost:9001`
*   Логин: `minio_admin`
*   Пароль: `minio_password`

---

## 3. ОСТАНОВКА ПРОЕКТА

Чтобы полностью выключить проект и **освободить оперативную память**, потребляемую виртуальной машиной Docker (WSL/Hyper-V), выполните:

1.  Остановите сервер (`Ctrl+C` в терминале с `npm run start:dev`).
2.  Выполните команду остановки контейнеров:
```bash
docker compose down
```
*Эта команда останавливает и удаляет контейнеры, но сохраняет данные в томах (volumes).*

---

### Полезные команды

**Backend:**
*   `npm run test`: Запуск модульных тестов.
*   `npm run test:e2e`: Запуск сквозных (End-to-End) тестов API.
*   `npx prisma migrate reset`: Полный сброс БД и перезалив данных.

**Frontend:**
*   `npm run test`: Запуск Unit и Component тестов (Jest).
*   `npx playwright test`: Запуск E2E тестов интерфейса (в headless режиме).
*   `npx playwright test --ui`: Запуск E2E тестов с визуальным интерфейсом.